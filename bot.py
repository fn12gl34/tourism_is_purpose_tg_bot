import os
import time
from multiprocessing.context import Process

from flask import Flask, request
import telebot
from telebot.types import ChatPermissions
import schedule

TOKEN = os.getenv('TG_BOT_APIKEY')
CHAT_ID = os.getenv('CHAT_ID')
TEST_CHAT_ID = os.getenv('TEST_CHAT_ID')
APP_URL = os.getenv('APP_URL')

bot = telebot.TeleBot(TOKEN)
server = Flask(__name__)


restrict_message = '''
–†–µ–±—è—Ç–∞, –º—ã –≤–∫–ª—é—á–∞–µ–º –º–µ–¥–ª–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –Ω–∞ –Ω–æ—á—å, –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ —á–∞—Å\\. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —á—Ç–æ–±—ã –Ω–æ—á—å—é –≤ —á–∞—Ç–µ –Ω–µ –±—ã–ª–æ —Ñ–ª—É–¥–∞ –∏ –Ω–∞—à –º–æ–¥–µ—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—á—å—é, —Å–º–æ–≥ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å –ø–æ—Ç–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π\\. –ü–æ—ç—Ç–æ–º—É —Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Å–≤–æ–π –∑–∞–ø—Ä–æ—Å –∏ –≤–æ–ø—Ä–æ—Å—ã –≤ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
 
–í 8 —É—Ç—Ä–∞ –ø–æ –ú—Å–∫\\. –æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ –ø–µ—Ä–µ–π–¥–µ—Ç –≤ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ –∞–∫—Ç–∏–≤–Ω–µ–µ –æ–±—â–∞—Ç—å—Å—è

–¢–∞–∫–∂–µ –Ω–∞–ø–æ–º–∏–Ω–∞–µ–º –≤–∞–º –ø—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞:
\\- –Ω–µ —Ñ–ª—É–¥–∏—Ç—å
\\- –Ω–µ –≥—Ä—É–±–∏—Ç—å –¥—Ä—É–≥–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
\\- –Ω–µ –∫–∏–¥–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –≤ –∫–æ—Ç–æ—Ä–æ–π –≤—ã –Ω–µ —É–≤–µ—Ä–µ–Ω—ã \\(–ø–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–µ –ø—Ä–∞–≤–¥–∏–≤–æ—Å—Ç—å –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ —à–µ—Ä–∏—Ç—å —Å –æ–∫—Ä—É–∂–∞—é—â–∏–º–∏\\)
\\- –ø—Ä–µ–∂–¥–µ, —á–µ–º –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å, –Ω—É–∂–Ω–æ –ø–æ–∏—Å–∫–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ –Ω–∞—à–µ–º [–≥–∞–π–¥–µ](https://www.notion.so/b3f5058775464ccb8b7896a78fe57b54), —á–∞—Ç–µ –∏ –≤ –∑–∞–∫—Ä–µ–ø–∞—Ö 

–ù–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ –∏—Ö, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏ –±—É–¥—å—Ç–µ –±–µ—Ä–µ–∂–Ω—ã –¥—Ä—É–≥ –∫ –¥—Ä—É–≥—É\\! –î–æ–±—Ä–æ–π –Ω–æ—á–∏ü§ç
'''

unrestrict_message = '''
–†–µ–±—è—Ç, –º–µ–¥–ª–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –≤ —á–∞—Ç–µ –≤—ã–∫–ª—é—á–µ–Ω, —Ç–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ –æ–±—â–∞—Ç—å—Å—è

–û–±–º–µ–Ω–∏–≤–∞–π—Ç–µ—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, –ø–æ–º–æ–≥–∞–π—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥—É –∏ –±—É–¥—å—Ç–µ –±–µ—Ä–µ–∂–Ω—ã –∫ –æ–∫—Ä—É–∂–∞—é—â–∏–º

–ù–∞–ø–æ–º–∏–Ω–∞–µ–º –≤–∞–º –ø—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞:
\\- –Ω–µ —Ñ–ª—É–¥–∏—Ç—å
\\- –Ω–µ –≥—Ä—É–±–∏—Ç—å –¥—Ä—É–≥–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
\\- –Ω–µ –∫–∏–¥–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –≤ –∫–æ—Ç–æ—Ä–æ–π –≤—ã –Ω–µ —É–≤–µ—Ä–µ–Ω—ã \\(–ø–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–µ –ø—Ä–∞–≤–¥–∏–≤–æ—Å—Ç—å –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ —à–µ—Ä–∏—Ç—å —Å –æ–∫—Ä—É–∂–∞—é—â–∏–º–∏\\)
\\- –ø—Ä–µ–∂–¥–µ, —á–µ–º –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å, –Ω—É–∂–Ω–æ –ø–æ–∏—Å–∫–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ –Ω–∞—à–µ–º –≥–∞–π–¥–µ, —á–∞—Ç–µ –∏ –≤ –∑–∞–∫—Ä–µ–ø–∞—Ö 

–•–æ—Ä–æ—à–µ–≥–æ –≤–∞–º –¥–Ω—è\\! ü§ç
'''

info_message = '''
–†–µ–±—è—Ç–∞, –≤—Å–µ–º –ø—Ä–∏–≤–µ—Ç\\!

–ù–∞–ø–æ–º–∏–Ω–∞–µ–º –≤–∞–º –æ –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ \\- –º—ã –ø–æ–º–æ–≥–∞–µ–º –≤ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –≤ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–µ –ª—é–¥—è–º, –∫–æ—Ç–æ—Ä—ã–µ —É–µ–∑–∂–∞—é—Ç –∏–∑ –†–æ—Å—Å–∏–∏

–°–µ–π—á–∞—Å –º—ã –∞–∫—Ç–∏–≤–Ω–æ –∏—â–µ–º –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –≥–æ—Ç–æ–≤—ã –æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–º–æ—â—å —É–µ–∑–∂–∞—é—â–∏–º\\.

–ö–∞–∫ –º–æ–∂–Ω–æ –ø–æ–º–æ—á—å:

\\- –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∂–∏–ª—å–µ –Ω–∞ –ø–µ—Ä–≤–æ–µ –≤—Ä–µ–º—è –∏–ª–∏ –ø–æ–º–æ—á—å –µ–≥–æ –Ω–∞–π—Ç–∏
\\- –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å –æ—Ç –≥—Ä–∞–Ω–∏—Ü—ã –∏–ª–∏ –ø–æ–º–æ—á—å –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä
\\- –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –±—ã—Ç–æ–≤—ã–º –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∞—Ö
\\- –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å
\\- –∑–∞–¥–æ–Ω–∞—Ç–∏—Ç—å

–ï—Å–ª–∏ –≤—ã –≥–æ—Ç–æ–≤—ã —Å—Ç–∞—Ç—å –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–º, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, [—Ñ–æ—Ä–º—É](https://airtable.com/shrUZIxbaoV0Lyk7c)\\. –ö–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–∞–ø—Ä–æ—Å, –ø–æ–º–æ—á—å –≤ –∫–æ—Ç–æ—Ä–æ–º —Å–º–æ–∂–µ—Ç–µ –∏–º–µ–Ω–Ω–æ –≤—ã, –∫—É—Ä–∞—Ç–æ—Ä –Ω–∞–ø–∏—à–µ—Ç –≤–∞–º –≤ —Ç–≥ –∏ —Å–≤—è–∂–µ—Ç –≤–∞—Å —Å —ç–≤–∞–∫—É–∞–Ω—Ç–æ–º

–ï—Å–ª–∏ –≤–∞–º –∏–ª–∏ –≤–∞—à–∏–º –±–ª–∏–∑–∫–∏–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —ç—Ç—É [—Ñ–æ—Ä–º—É](https://airtable.com/shrUWtxaCUGaXzCjq)\\. 
–ù–∞—à –∫—É—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏, –æ—Ç–≤–µ—Ç–∏—Ç –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –∏ —Å–≤—è–∂–µ—Ç —Å –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–º –∏–∑ —Ç–æ–π —Å—Ç—Ä–∞–Ω—ã, –≤ –∫–æ—Ç–æ—Ä—É—é –≤—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —Ä–µ–ª–æ—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è

–¢–∞–∫–∂–µ —É –Ω–∞—Å –µ—Å—Ç—å [–≥–∞–π–¥](https://www.notion.so/b3f5058775464ccb8b7896a78fe57b54) –ø–æ —Ä–∞–∑–Ω—ã–º —Å—Ç—Ä–∞–Ω–∞–º, –∫–æ—Ç–æ—Ä—ã–π –º—ã –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π\\. –ù–∞–¥–µ–µ–º—Å—è, –æ–Ω –≤–∞–º –ø–æ–º–æ–∂–µ—Ç

–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞—Å —Å—Ä–µ–¥–∏ –¥—Ä—É–∑–µ–π, –¥–∞–≤–∞–π—Ç–µ –ø–æ–º–æ–≥–∞—Ç—å –≤–º–µ—Å—Ç–µ\\! ü§ç
'''

def send_info_msg_to_chat():
    bot.send_message(CHAT_ID, info_message, parse_mode='MarkdownV2', disable_web_page_preview=True)
    
    
def restrict_chat_settings():
    bot.send_message(TEST_CHAT_ID, restrict_message, parse_mode='MarkdownV2', disable_web_page_preview=True)
    chp = ChatPermissions(can_send_messages=False)
    bot.set_chat_permissions(TEST_CHAT_ID, permissions=chp)
    
    
def unrestrict_chat_settings():
    bot.send_message(TEST_CHAT_ID, unrestrict_message, parse_mode='MarkdownV2', disable_web_page_preview=True)
    chp = ChatPermissions(can_send_messages=True, can_send_media_messages=True, can_send_other_messages=True, can_invite_users=True, can_add_web_page_previews=True)
    bot.set_chat_permissions(TEST_CHAT_ID, permissions=chp)
    

@server.route('/' + TOKEN, methods=['POST'])
def getMessage():
    json_string = request.get_data().decode('utf-8')
    update = telebot.types.Update.de_json(json_string)
    bot.process_new_updates([update])
    return '!', 200


@server.route('/')
def webhook():
    bot.remove_webhook()
    bot.set_webhook(url=APP_URL + TOKEN)
    return '!', 200


@bot.message_handler(content_types=['new_chat_members'])
def remove_info(message):
    bot.delete_message(message.chat.id, message.message_id)
    
    
class ScheduleMessage:
    def send_schedule():
        while True:
            schedule.run_pending()
            time.sleep(10)
            
    def start_process():
        p = Process(target=ScheduleMessage.send_schedule, args=())
        p.start()

if __name__ == '__main__':
    if CHAT_ID:
        if TEST_CHAT_ID:
            schedule.every(2).minutes.do(restrict_chat_settings)
            schedule.every(4).minutes.do(unrestrict_chat_settings)
        schedule.every().day.at('09:00').do(send_info_msg_to_chat)
        ScheduleMessage.start_process() 
    server.run(host='0.0.0.0', port=int(os.environ.get('PORT', 5000)))
